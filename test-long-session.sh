#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π —Ä–∞–±–æ—Ç—ã WhatsApp —Å–µ—Å—Å–∏–∏

echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π —Ä–∞–±–æ—Ç—ã WhatsApp —Å–µ—Å—Å–∏–∏..."

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–æ—Ç–∞
check_bot_status() {
    echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–æ—Ç–∞..."
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã PM2
    if command -v pm2 >/dev/null 2>&1; then
        echo "üîÑ –°—Ç–∞—Ç—É—Å PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:"
        pm2 status
        echo ""
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏
    if command -v pm2 >/dev/null 2>&1; then
        echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ –±–æ—Ç–∞:"
        pm2 logs nord-laundry-bot --lines 10 --nostream
        echo ""
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞–ø–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    if [ -d ".wwebjs_auth" ]; then
        echo "üìÅ –ü–∞–ø–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞–π–¥–µ–Ω–∞"
        echo "üìä –†–∞–∑–º–µ—Ä –ø–∞–ø–∫–∏: $(du -sh .wwebjs_auth/ | cut -f1)"
        echo "üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤: $(find .wwebjs_auth/ -type f | wc -l)"
    else
        echo "‚ùå –ü–∞–ø–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    fi
    
    echo ""
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
monitor_realtime() {
    echo "üëÅÔ∏è –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏..."
    echo "üí° –ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞"
    echo ""
    
    while true; do
        clear
        echo "üïê $(date)"
        echo "=================================="
        check_bot_status
        
        # –ñ–¥–µ–º 30 —Å–µ–∫—É–Ω–¥
        sleep 30
    done
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API
test_api() {
    echo "üåê –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API endpoint..."
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ webhook-server –∑–∞–ø—É—â–µ–Ω
    if curl -s http://localhost:3001/api/application >/dev/null 2>&1; then
        echo "‚úÖ API endpoint –¥–æ—Å—Ç—É–ø–µ–Ω"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞—è–≤–∫—É
        echo "üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞—è–≤–∫—É..."
        response=$(curl -s -X POST http://localhost:3001/api/application \
            -H "Content-Type: application/json" \
            -d '{
                "name": "–¢–µ—Å—Ç –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π —Å–µ—Å—Å–∏–∏",
                "phone": "+79991234567",
                "source": "website_form",
                "messageType": "text",
                "userMessage": "–¢–µ—Å—Ç —Ä–∞–±–æ—Ç—ã —Å–µ—Å—Å–∏–∏"
            }')
        
        echo "üì• –û—Ç–≤–µ—Ç API: $response"
    else
        echo "‚ùå API endpoint –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ä—Ö–∏–≤–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
create_backup() {
    echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏..."
    
    if [ -d ".wwebjs_auth" ]; then
        timestamp=$(date +"%Y%m%d_%H%M%S")
        backup_name="whatsapp_auth_backup_${timestamp}.tar.gz"
        
        tar -czf "$backup_name" .wwebjs_auth/
        echo "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: $backup_name"
    else
        echo "‚ùå –ü–∞–ø–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    fi
}

# –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é
case "${1:-menu}" in
    "status")
        check_bot_status
        ;;
    "monitor")
        monitor_realtime
        ;;
    "test-api")
        test_api
        ;;
    "backup")
        create_backup
        ;;
    "full-test")
        echo "üß™ –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π —Å–µ—Å—Å–∏–∏..."
        check_bot_status
        test_api
        create_backup
        echo ""
        echo "‚úÖ –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω"
        ;;
    *)
        echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π —Ä–∞–±–æ—Ç—ã WhatsApp —Å–µ—Å—Å–∏–∏"
        echo ""
        echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [–∫–æ–º–∞–Ω–¥–∞]"
        echo ""
        echo "–ö–æ–º–∞–Ω–¥—ã:"
        echo "  status     - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–æ—Ç–∞"
        echo "  monitor    - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏"
        echo "  test-api   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API endpoint"
        echo "  backup     - –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"
        echo "  full-test  - –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç"
        echo ""
        echo "–ü—Ä–∏–º–µ—Ä—ã:"
        echo "  $0 status"
        echo "  $0 monitor"
        echo "  $0 full-test"
        ;;
esac
