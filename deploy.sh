#!/bin/bash

echo "üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –±–æ—Ç–∞ –Ω–∞ VPS..."

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo -e "${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–∞–ø–∫–µ
if [ ! -f "package.json" ] || [ ! -f "ecosystem.config.cjs" ]; then
    error "–ù–µ –Ω–∞–π–¥–µ–Ω package.json –∏–ª–∏ ecosystem.config.cjs"
    error "–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞"
    exit 1
fi

log "–ù–∞—á–∏–Ω–∞–µ–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ..."

# 1. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2 –ø—Ä–æ—Ü–µ—Å—Å
log "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2 –ø—Ä–æ—Ü–µ—Å—Å..."
pm2 stop nord-laundry-bot 2>/dev/null || warning "–ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω"

# 2. –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é —Ç–µ–∫—É—â–µ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
if [ -d ".wwebjs_auth" ]; then
    log "–°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é —Ç–µ–∫—É—â–µ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏..."
    BACKUP_NAME="backup_auth_$(date +%Y%m%d_%H%M%S).tar.gz"
    tar -czf "$BACKUP_NAME" .wwebjs_auth/ 2>/dev/null
    if [ $? -eq 0 ]; then
        success "–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: $BACKUP_NAME"
    else
        warning "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é"
    fi
fi

# 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
log "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
npm install --production

if [ $? -ne 0 ]; then
    error "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
    exit 1
fi

# 4. –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º TypeScript
log "–ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º TypeScript..."
npm run build

if [ $? -ne 0 ]; then
    error "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ TypeScript"
    exit 1
fi

# 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ .env —Ñ–∞–π–ª–∞
if [ ! -f ".env" ]; then
    error "–§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    error "–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏"
    exit 1
fi

# 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ WhatsApp
if [ ! -d ".wwebjs_auth" ]; then
    warning "–ü–∞–ø–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ WhatsApp –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    warning "–ë–æ—Ç –±—É–¥–µ—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –Ω–æ–≤—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ"
    
    # –ò—â–µ–º –∞—Ä—Ö–∏–≤—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    AUTH_ARCHIVES=$(ls whatsapp_auth_*.tar.gz 2>/dev/null | head -1)
    if [ -n "$AUTH_ARCHIVES" ]; then
        log "–ù–∞–π–¥–µ–Ω –∞—Ä—Ö–∏–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: $AUTH_ARCHIVES"
        read -p "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∏–∑ –∞—Ä—Ö–∏–≤–∞? (y/n): " RESTORE_AUTH
        
        if [ "$RESTORE_AUTH" = "y" ] || [ "$RESTORE_AUTH" = "Y" ]; then
            log "–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é..."
            tar -xzf "$AUTH_ARCHIVES"
            if [ $? -eq 0 ]; then
                success "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
            else
                error "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"
            fi
        fi
    fi
fi

# 7. –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –ª–æ–≥–æ–≤
log "–°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –ª–æ–≥–æ–≤..."
mkdir -p logs

# 8. –ó–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ PM2
log "–ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ —á–µ—Ä–µ–∑ PM2..."
pm2 start ecosystem.config.cjs

if [ $? -eq 0 ]; then
    success "–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ PM2"
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
    log "–°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:"
    pm2 status
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é PM2
    pm2 save
    
    log "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è PM2 —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞"
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏
    log "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
    pm2 logs nord-laundry-bot --lines 10
    
else
    error "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞"
    exit 1
fi

success "–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
log "–î–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: pm2 monit"
log "–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤: pm2 logs nord-laundry-bot"
log "–î–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞: pm2 restart nord-laundry-bot"
