#!/bin/bash

# VPS WhatsApp Auth Reset Script
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ WhatsApp –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞ VPS

echo "üîß VPS: –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ WhatsApp –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"
echo "============================================="
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –º—ã –Ω–∞ VPS (–ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ PM2)
if ! command -v pm2 &> /dev/null; then
    echo "‚ö†Ô∏è  PM2 –Ω–µ –Ω–∞–π–¥–µ–Ω. –í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —ç—Ç–æ VPS?"
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
echo "üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:"
pm2 list 2>/dev/null || echo "PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
echo ""

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
echo "‚èπÔ∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
pm2 stop all 2>/dev/null
pm2 delete all 2>/dev/null
echo "‚úÖ PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
sleep 2

# –£–±–∏–≤–∞–µ–º –≤—Å–µ Node –ø—Ä–æ—Ü–µ—Å—Å—ã (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
echo "üî™ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤—Å–µ—Ö Node –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
pkill -9 node 2>/dev/null || echo "–ê–∫—Ç–∏–≤–Ω—ã—Ö Node –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
sleep 2

# –£–¥–∞–ª—è–µ–º –ø–∞–ø–∫—É —Å–µ—Å—Å–∏–π
echo "üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ .wwebjs_auth/..."
if [ -d ".wwebjs_auth" ]; then
    rm -rf .wwebjs_auth/
    echo "‚úÖ –ü–∞–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∞"
else
    echo "‚ö†Ô∏è  –ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
fi

# –£–¥–∞–ª—è–µ–º –≤—Å–µ –∞—Ä—Ö–∏–≤—ã
echo "üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∞—Ä—Ö–∏–≤–æ–≤ WhatsApp..."
rm -f whatsapp_auth_*.tar.gz 2>/dev/null
if [ $? -eq 0 ]; then
    echo "‚úÖ –ê—Ä—Ö–∏–≤—ã —É–¥–∞–ª–µ–Ω—ã"
else
    echo "‚ö†Ô∏è  –ê—Ä—Ö–∏–≤—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
fi

# –£–¥–∞–ª—è–µ–º –∏–∑ Git (–µ—Å–ª–∏ –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω)
echo "üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ Git –∫—ç—à–∞..."
git rm --cached whatsapp_auth_latest.tar.gz 2>/dev/null || echo "–§–∞–π–ª –Ω–µ –≤ Git"
git rm --cached .wwebjs_auth/ 2>/dev/null || echo "–ü–∞–ø–∫–∞ –Ω–µ –≤ Git"

# –£–¥–∞–ª—è–µ–º Chromium/Puppeteer –∫—ç—à–∏
echo "üóëÔ∏è  –û—á–∏—Å—Ç–∫–∞ Chromium/Puppeteer –∫—ç—à–µ–π..."
rm -rf /tmp/.org.chromium.Chromium.* 2>/dev/null
rm -rf /tmp/puppeteer_dev_chrome_profile-* 2>/dev/null
rm -rf ~/.config/chromium/ 2>/dev/null
rm -rf /tmp/chrome-* 2>/dev/null
echo "‚úÖ –ö—ç—à–∏ –æ—á–∏—â–µ–Ω—ã"

# –û—á–∏—Å—Ç–∫–∞ PM2 –ª–æ–≥–æ–≤ –∏ –¥–∞–Ω–Ω—ã—Ö
echo "üóëÔ∏è  –û—á–∏—Å—Ç–∫–∞ PM2 –ª–æ–≥–æ–≤..."
pm2 flush 2>/dev/null
rm -rf ~/.pm2/logs/* 2>/dev/null
echo "‚úÖ –õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã"

# –û—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
echo "üóëÔ∏è  –û—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö temp —Ñ–∞–π–ª–æ–≤..."
rm -rf /tmp/wwebjs_* 2>/dev/null
rm -rf /tmp/puppeteer* 2>/dev/null
echo "‚úÖ Temp —Ñ–∞–π–ª—ã –æ—á–∏—â–µ–Ω—ã"

echo ""
echo "======================================"
echo "‚úÖ –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "======================================"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:"
ERRORS=0

if [ -d ".wwebjs_auth" ]; then
    echo "‚ùå .wwebjs_auth/ –≤—Å—ë –µ—â—ë —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!"
    ERRORS=$((ERRORS+1))
else
    echo "‚úÖ .wwebjs_auth/ —É–¥–∞–ª–µ–Ω–∞"
fi

if ls whatsapp_auth_*.tar.gz 1> /dev/null 2>&1; then
    echo "‚ùå –ù–∞–π–¥–µ–Ω—ã –∞—Ä—Ö–∏–≤—ã whatsapp_auth_*.tar.gz"
    ls -lh whatsapp_auth_*.tar.gz
    ERRORS=$((ERRORS+1))
else
    echo "‚úÖ –ê—Ä—Ö–∏–≤—ã —É–¥–∞–ª–µ–Ω—ã"
fi

echo ""
if [ $ERRORS -eq 0 ]; then
    echo "üéâ –í—Å—ë —á–∏—Å—Ç–æ! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –Ω–æ–º–µ—Ä"
else
    echo "‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–≤–æ–¥ –≤—ã—à–µ."
fi

echo ""
echo "üì± –î–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –Ω–æ–º–µ—Ä–∞:"
echo "   1. –°–æ–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç: npm run build"
echo "   2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç: pm2 start bot-runner.mjs --name laundry-bot"
echo "   3. –°–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏: pm2 logs laundry-bot"
echo "   4. –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ –¥–ª—è –Ω–æ–≤–æ–≥–æ –Ω–æ–º–µ—Ä–∞"
echo ""
echo "üí° –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ QR –∫–æ–¥–∞ –≤ –ª–æ–≥–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:"
echo "   pm2 logs laundry-bot --lines 100"
echo ""
