#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –æ—Ç –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
# –£–¥–∞–ª—è–µ—Ç –∞—Ä—Ö–∏–≤—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ WhatsApp –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ Git

set -e

echo "üßπ –û—á–∏—Å—Ç–∫–∞ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –æ—Ç –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
if [ ! -d ".git" ]; then
    echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"
    exit 1
fi

# –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
echo "üíæ –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é..."
git branch backup-before-cleanup 2>/dev/null || true

# –£–¥–∞–ª—è–µ–º –±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ Git
echo "üóëÔ∏è –£–¥–∞–ª—è–µ–º –∞—Ä—Ö–∏–≤—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ Git..."

# –°–ø–∏—Å–æ–∫ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ —Ñ–∞–π–ª–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
PATTERNS=(
    "whatsapp_auth_*.tar.gz"
    "whatsapp_auth_latest.tar.gz"
    "whatsapp_auth_2025-*.tar.gz"
    "whatsapp_auth_202510*.tar.gz"
)

# –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ Git
for pattern in "${PATTERNS[@]}"; do
    echo "üîç –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É: $pattern"
    git filter-branch --force --index-filter \
        "git rm --cached --ignore-unmatch $pattern" \
        --prune-empty --tag-name-filter cat -- --all 2>/dev/null || true
done

# –û—á–∏—â–∞–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
echo "üßπ –û—á–∏—â–∞–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã..."
git for-each-ref --format="delete %(refname)" refs/original | git update-ref --stdin 2>/dev/null || true

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—á–∏—â–∞–µ–º Git
echo "üí® –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ Git..."
git reflog expire --expire=now --all 2>/dev/null || true
git gc --prune=now --aggressive 2>/dev/null || true

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏
echo "üìä –†–∞–∑–º–µ—Ä Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏:"
du -sh .git

echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:"
echo "   1. –°–¥–µ–ª–∞–π—Ç–µ git push --force-with-lease –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
echo "   2. –£–≤–µ–¥–æ–º–∏—Ç–µ –¥—Ä—É–≥–∏—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"
echo "   3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ .gitignore –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤"
