#!/bin/bash

# –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤ WhatsApp –Ω–∞ VPS
# –í–µ—Ä—Å–∏—è: 1.4.1
# –î–∞—Ç–∞: 2025-10-13

echo "üîß –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ WhatsApp –Ω–∞ VPS"
echo "======================================"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "package.json" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞"
    exit 1
fi

# –®–∞–≥ 1: –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞
echo "1Ô∏è‚É£ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞..."
pm2 stop nord-laundry-bot || echo "‚ö†Ô∏è –ë–æ—Ç –Ω–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω"

# –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–µ—Å—Å–∏–∏
echo ""
echo "2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Å—Å–∏—é WhatsApp..."
if [ -d ".wwebjs_auth/session-nord-laundry-whatsapp" ]; then
    echo "‚úÖ –°–µ—Å—Å–∏—è –Ω–∞–π–¥–µ–Ω–∞"
    ls -lh .wwebjs_auth/session-nord-laundry-whatsapp/ | head -5
else
    echo "‚ö†Ô∏è –°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
    
    # –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –∞—Ä—Ö–∏–≤–∞
    if [ -f "whatsapp_auth_latest.tar.gz" ]; then
        echo "üì¶ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ –∞—Ä—Ö–∏–≤–∞..."
        tar -xzf whatsapp_auth_latest.tar.gz
        chmod -R 755 .wwebjs_auth/
        echo "‚úÖ –°–µ—Å—Å–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑ –∞—Ä—Ö–∏–≤–∞"
    else
        echo "‚ùå –ê—Ä—Ö–∏–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω! –ü–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è QR –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è"
        echo "üí° –°–∫–æ–ø–∏—Ä—É–π—Ç–µ whatsapp_auth_latest.tar.gz —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã"
    fi
fi

# –®–∞–≥ 3: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
echo ""
echo "3Ô∏è‚É£ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞..."
if [ -d ".wwebjs_auth" ]; then
    chmod -R 755 .wwebjs_auth/
    chown -R $(whoami):$(whoami) .wwebjs_auth/ 2>/dev/null || true
    echo "‚úÖ –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
fi

# –®–∞–≥ 4: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
echo ""
echo "4Ô∏è‚É£ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞..."
pm2 restart nord-laundry-bot || pm2 start ecosystem.config.cjs

# –®–∞–≥ 5: –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
echo ""
echo "5Ô∏è‚É£ –û–∂–∏–¥–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (30 —Å–µ–∫—É–Ω–¥)..."
sleep 30

# –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏
echo ""
echo "6Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ WhatsApp..."
echo "======================================"
pm2 logs nord-laundry-bot --lines 20 --nostream | grep -E "(WhatsApp|–≥–æ—Ç–æ–≤|–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫|–æ—à–∏–±–∫–∞)" || true

echo ""
echo "======================================"
echo "‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ!"
echo ""
echo "üìä –ß—Ç–æ –¥–∞–ª—å—à–µ:"
echo "   1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: pm2 logs nord-laundry-bot"
echo "   2. –î–æ–∂–¥–∏—Ç–µ—Å—å —Å–æ–æ–±—â–µ–Ω–∏—è: ‚úÖ WhatsApp –±–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!"
echo "   3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ WhatsApp"
echo "   4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞—è–≤–∫–∞ –ø–æ–ø–∞–ª–∞ –≤ Telegram"
echo ""
echo "üÜò –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã –æ—Å—Ç–∞–ª–∏—Å—å:"
echo "   - –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ VPS_RESTART_FIX.md"
echo "   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: pm2 logs nord-laundry-bot | grep '–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫'"
echo "   - –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤"
echo ""
