#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è WhatsApp —Å–µ—Å—Å–∏–∏ –Ω–∞ VPS
# –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–∏—Å—Ç–µ–º—ã –∏–ª–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

AUTH_DIR=".wwebjs_auth"
ARCHIVE_FILE="whatsapp_auth_latest.tar.gz"
BACKUP_DIR="/opt/whatsapp-auth-backup"
LOG_FILE="/var/log/whatsapp-auth-restore.log"

# –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
restore_session() {
    log "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è WhatsApp —Å–µ—Å—Å–∏–∏..."
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–∞–ø–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    if [ -d "$AUTH_DIR" ]; then
        log "‚úÖ –ü–∞–ø–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: $AUTH_DIR"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—É—Å—Ç–∞—è –ª–∏ –ø–∞–ø–∫–∞
        if [ "$(ls -A $AUTH_DIR 2>/dev/null)" ]; then
            log "‚úÖ –ü–∞–ø–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –ø—É—Å—Ç–∞—è, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
            return 0
        else
            log "‚ö†Ô∏è –ü–∞–ø–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—É—Å—Ç–∞—è, —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ"
        fi
    else
        log "‚ö†Ô∏è –ü–∞–ø–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $AUTH_DIR"
    fi
    
    # –ò—â–µ–º –∞—Ä—Ö–∏–≤ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
    local archive_path=""
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    if [ -f "$ARCHIVE_FILE" ]; then
        archive_path="$ARCHIVE_FILE"
        log "üì¶ –ù–∞–π–¥–µ–Ω –∞—Ä—Ö–∏–≤ –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: $ARCHIVE_FILE"
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –±—ç–∫–∞–ø–∞
    elif [ -f "$BACKUP_DIR/$ARCHIVE_FILE" ]; then
        archive_path="$BACKUP_DIR/$ARCHIVE_FILE"
        log "üì¶ –ù–∞–π–¥–µ–Ω –∞—Ä—Ö–∏–≤ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –±—ç–∫–∞–ø–∞: $BACKUP_DIR/$ARCHIVE_FILE"
    # –ò—â–µ–º –ª—é–±–æ–π –∞—Ä—Ö–∏–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    else
        archive_path=$(find . -name "whatsapp_auth_*.tar.gz" -type f -printf '%T@ %p\n' | sort -n | tail -1 | cut -d' ' -f2-)
        if [ -n "$archive_path" ]; then
            log "üì¶ –ù–∞–π–¥–µ–Ω –∞—Ä—Ö–∏–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: $archive_path"
        fi
    fi
    
    if [ -z "$archive_path" ] || [ ! -f "$archive_path" ]; then
        log "‚ùå –ê—Ä—Ö–∏–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞–π—Ç–µ –∞—Ä—Ö–∏–≤ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–∞ VPS"
        return 1
    fi
    
    # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    mkdir -p "$AUTH_DIR"
    
    # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ –∞—Ä—Ö–∏–≤–∞
    log "üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Å—Å–∏—é –∏–∑ –∞—Ä—Ö–∏–≤–∞: $archive_path"
    
    if tar -xzf "$archive_path" -C .; then
        log "‚úÖ –°–µ—Å—Å–∏—è —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑ –∞—Ä—Ö–∏–≤–∞"
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
        chmod -R 755 "$AUTH_DIR"
        chown -R $(whoami):$(whoami) "$AUTH_DIR" 2>/dev/null || true
        
        # –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        mkdir -p "$BACKUP_DIR"
        cp "$archive_path" "$BACKUP_DIR/" 2>/dev/null || true
        
        log "‚úÖ –ë—ç–∫–∞–ø –∞—Ä—Ö–∏–≤–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: $BACKUP_DIR"
        return 0
    else
        log "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏ –∏–∑ –∞—Ä—Ö–∏–≤–∞"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ —Å–µ—Å—Å–∏–∏
check_session_integrity() {
    log "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å WhatsApp —Å–µ—Å—Å–∏–∏..."
    
    if [ ! -d "$AUTH_DIR" ]; then
        log "‚ùå –ü–∞–ø–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
        return 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ —Å–µ—Å—Å–∏–∏
    local required_files=("session-*" "LocalStorage" "IndexedDB")
    local missing_files=()
    
    for pattern in "${required_files[@]}"; do
        if ! ls "$AUTH_DIR"/$pattern >/dev/null 2>&1; then
            missing_files+=("$pattern")
        fi
    done
    
    if [ ${#missing_files[@]} -eq 0 ]; then
        log "‚úÖ –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å —Å–µ—Å—Å–∏–∏ –≤ –ø–æ—Ä—è–¥–∫–µ"
        return 0
    else
        log "‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã —Å–µ—Å—Å–∏–∏: ${missing_files[*]}"
        return 1
    fi
}

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
main() {
    log "üöÄ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è WhatsApp —Å–µ—Å—Å–∏–∏"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–µ—Å—Å–∏–∏
    if check_session_integrity; then
        log "‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Å–µ—Å—Å–∏—è –≤ –ø–æ—Ä—è–¥–∫–µ, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
        exit 0
    fi
    
    # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Å—Å–∏—é
    if restore_session; then
        log "‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ"
        exit 0
    else
        log "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Å—Å–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
        log "üí° –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–æ–µ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ:"
        log "   1. –°–æ–∑–¥–∞–π—Ç–µ –∞—Ä—Ö–∏–≤ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ"
        log "   2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –µ–≥–æ –Ω–∞ VPS"
        log "   3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: tar -xzf whatsapp_auth_latest.tar.gz"
        exit 1
    fi
}

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
case "${1:-}" in
    "force")
        log "üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏"
        restore_session
        ;;
    "check")
        check_session_integrity
        ;;
    "help"|"-h"|"--help")
        echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [–∫–æ–º–∞–Ω–¥–∞]"
        echo ""
        echo "–ö–æ–º–∞–Ω–¥—ã:"
        echo "  (–±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤) - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ"
        echo "  force            - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ"
        echo "  check            - —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏"
        echo "  help             - –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
        ;;
    *)
        main
        ;;
esac
